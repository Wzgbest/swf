var weixin_timer;

function login_modal(tid) {
    var html = '<div class="graybg" id="graybg"></div>';
    html += '<div class="dlcontmain" id="login-modal">';
    html += '<div class="closed" onclick="closeLoginModal()">×</div>';
    html += '<dl id="login-menu">';
    html += '<dt><img src="/static/index/images/logo.png"></dt>';
    html += '<dd style="padding-top: 20px;"><fieldset><legend>账号登录</legend></fieldset></dd>';
    html += '<dd style="padding-top: 20px;"><input style="height: 35px;width: 260px;" class="zhanghao" type="text" placeholder="账户"></dd>';
    html += '<dd style="padding-top: 20px;"><input style="height: 35px;width: 260px;" class="mima" type="password" placeholder="密码"></dd>';
    // html += '<dd style="padding-top: 20px;"><input style="height: 35px;width: 100px;" class="yanzhengma" type="text" placeholder="验证码" onblur="if(this.value==\'\'){this.value=\'验证码:\'}" onclick="if(this.value==\'验证码:\'){this.value=\'\';}" value="验证码:" style="width:150px;">';
    // html += '<img src="{:captcha_src()}" onclick="this.src=\'{:captcha_src()}?x=\'+Math.random();" style="height: 35px;width: 160px;"/></dd>'
    html += '<dd style="padding-top: 20px;"><input style="width: 100px; height: 40px;" name="tijiao" type="button" value="&nbsp;登&nbsp;&nbsp;&nbsp;&nbsp;录&nbsp;" onclick="submit('+tid+')"></dd>';
    html += '</dl>';
    html += '</div>';
    $('body').append(html)
}
function submit(tid) {
    var account = $(".zhanghao").val();
    var psw = $(".mima").val();
    var code = $(".yanzhengma").val();
    console.log(account);
    $.ajax({
        url:"/index/member/verifyLogin",
        type:"POST",
        data:{"account":account,"psw":psw,"code":code},
        async:false,
        success:function (data) {
            if(data.status){
                if (tid > 0) {
                    window.location.href = '/index/member/mvAdd/id/'+tid+'/new/1';
                }else {
                    location.reload();
                }
            }else {
                alert(data.message);
            }
        },
        error:function () {
            alert("请求错误");
        },
    });
}

function closeLoginModal() {
    $('#login-modal').remove();
    $('#graybg').remove();
    clearInterval(weixin_timer)
}

function qqlogin(tid) {
    $('#login-menu').hide();
    $('.dlcontmain').css({'width': '700px', 'margin-left': '-350px'});
    $('#qq-login').attr('src', '/member/auth/qq.html?tid=' + tid).show().one('load', function () {
        $('#backward').show()
    })
}

function wxlogin(tid) {
    $.post('/member/home/login', function (res) {
        $('#login-menu').hide();
        $('#backward').show();
        $('#qrcode').html('').qrcode({
            render: "canvas",
            width: 200,
            height: 200,
            text: res.data.authurl
        }).parent().show();
        weixin_timer = setInterval(function () {
            $.get('/home/weixin/getLoginStatus?rand=' + Math.random(), {'urid': res.data.urid}, function (response) {
                if (response !== null) {
                    if (response.error) {
                    } else {
                        if (tid > 0) {
                            location.href = '/member/video/addTemp.html?id=' + tid
                        } else if (tid == -1) {
                            location.href = '/member/payment.html'
                        } else {
                            location.reload()
                        }
                    }
                }
            }, 'json')
        }, 2000)
    }, 'json')
}

function backward() {
    $('#backward').hide();
    $('#qrcode').parent().hide();
    $('#qq-login').attr('src', '').hide();
    $('.dlcontmain').css({'width': '515px', 'margin-left': '-257px'});
    $('#login-menu').show();
    clearInterval(weixin_timer)
}