var clickable = !0;
var preview_clickable = !0;
var thumb_index = 2;
var thumb_timer;
var compositionstatus = 0;

function previewLayer(id, isEdit) {
    var html = '';
    $.post('/index/index/mvShow/id/' + id + '/isedit/' + isEdit, function (response) {
        if (response.error) {
            return !1
        }
        html = response.data;
        $("body").append(html);
        $('#free-trial').click(function () {
            if (preview_clickable) {
                preview_clickable = !1;
                var is_login = parseInt($('#is-login').val());
                if (is_login) {
                    location.href = '/index/member/mvAdd/id/'+id+'/new/1';
                } else {
                    closeLayer();
                    preview_clickable = !0;
                    login_modal(id)
                }
            }
        });
        // var thumb_li_len = $(".thumb-list ul li").length;
        // var thumb_ul_width = 186 * thumb_li_len;
        // thumb_width = thumb_ul_width > 940 ? 940 : thumb_ul_width + 10;
        // $(".thumb-list ul").width(thumb_ul_width);
        // $(".thumb-list").width(thumb_width);
        // $(".arrow-right").click(function () {
        //     if (thumb_index === thumb_li_len - 3) {
        //         thumb_index = 2
        //     } else {
        //         thumb_index++
        //     }
        //     set_pre_thumb_index(thumb_index)
        // });
        // $(".arrow-left").click(function () {
        //     if (thumb_index === 2) {
        //         thumb_index = thumb_li_len - 3
        //     } else {
        //         thumb_index--
        //     }
        //     set_pre_thumb_index(thumb_index)
        // });
        // if (thumb_li_len > 5) {
        //     setTimeout(function () {
        //         $(".arrow-right").trigger('click');
        //         thumb_timer = setInterval(function () {
        //             $(".arrow-right").trigger('click')
        //         }, 2000)
        //     }, 100)
        // }
    }, 'json')
}

function audioEdit() {
    var bgm_music_dom = $('#music-' + temp_bgm);
    if (bgm_music_dom.length === 0) {
        loadPrivateMusics(function () {
            audioEdit()
        });
        return !1
    }
    var music_title = bgm_music_dom.children('a').text();
    var html = '<div class="music-edit" id="layer-box">' + '<div class="closed" onclick="closeAudioLayer()">×</div>' + '<div class="contm">' + '<div class="title">音乐截选（' + music_title + '）</div>' + '<div class="mains">' + '<a class="btns" id="audio-cut-play"><i class="icon-pause"></i></a>' + '<div class="times startime">0:00</div>' + '<div class="track-slider">' + '<div class="zmlet">' + '<span class="lefttime">' + sec_format(music_start) + '</span>' + '<span class="righttime">' + sec_format(music_start + temp_len) + '</span>' + '<div class="leftdian dians"></div>' + '<div class="mcont"></div>' + '<div class="mprogress" id="acp-progress"></div>' + '<div class="rightdian dians"></div>' + '</div>' + '</div>' + '<div class="times endtime">' + sec_format(music_len) + '</div>' + '</div>' + '</div>' + '</div>' + '<div class="graybg" id="graybg"></div>';
    $("body").append(html);
    $('.music-li').removeClass('on').children('a').eq(0).removeClass('paused');
    var cur_music_icon = $('#current-music').find('i');
    cur_music_icon.removeClass('icon-pause').addClass('icon-play');
    var player = document.getElementById('player');
    player.src = bgm_music_dom.data('music');
    player.currentTime = music_start;
    player.addEventListener("timeupdate", acp_timeupdate);
    var audio_cut_play = $('#audio-cut-play');
    audio_cut_play.children('i').removeClass('icon-play').addClass('icon-pause');
    player.play();
    $('.sbtns').find('i').click(function () {
        $(this).addClass('on').siblings('i').removeClass('on')
    });
    audio_cut_play.click(function () {
        if (player.paused) {
            audio_cut_play.children('i').removeClass('icon-play').addClass('icon-pause');
            player.play()
        } else {
            audio_cut_play.children('i').removeClass('icon-pause').addClass('icon-play');
            player.pause()
        }
    });
    var music_duration = $('.zmlet');
    music_duration.css('left', Math.round(music_start * 520 / music_len));
    music_duration.css('width', Math.round(temp_len * 520 / music_len));
    var music_mouse_down = function (e) {
        audio_cut_play.children('i').removeClass('icon-pause').addClass('icon-play');
        player.pause();
        old_music_start = music_start;
        fromObj = music_duration;
        originX = e.pageX;
        offsetX = parseInt(fromObj.css('left'));
        music_dragging = !0
    };
    $('.leftdian').mousedown(function (e) {
        music_mouse_down(e)
    });
    $('.rightdian').mousedown(function (e) {
        music_mouse_down(e)
    })
}

function previewMyVideo(id) {
    $.get('/member/video/play', {'id': id}, function (response) {
        if (response.error) {
            diybox.alert({message: response.msg, clostBtn: !1});
            return
        }
        var pre_width, pre_height, pre_margin_left, pre_margin_top;
        switch (response.screentype) {
            case 1:
                pre_width = 270;
                pre_height = 480;
                pre_margin_left = 135;
                pre_margin_top = 240;
                break;
            case 2:
                pre_width = 728;
                pre_height = 413;
                pre_margin_left = 364;
                pre_margin_top = 206;
                break;
            case 3:
                pre_width = 413;
                pre_height = 413;
                pre_margin_left = 206;
                pre_margin_top = 364;
                break;
            default:
                pre_width = 728;
                pre_height = 413;
                pre_margin_left = 364;
                pre_margin_top = 206
        }
        var html = '<div class="previewlayer" id="layer-box" style="width: ' + pre_width + 'px; height: ' + pre_height + 'px; padding: 4px; margin-left: -' + pre_margin_left + 'px;margin-top: -' + pre_margin_top + 'px;">' + '<div class="closed" onclick="closeLayer()">×</div>' + '<div class="contm clearfix">' + '<div class="video fl" style="width: 100%; height: 100%;">' + '<video width="100%" height="100%" controls="controls" style="background:#5C595A;" id="video" autoplay="autoplay" loop="loop">' + '<source src="' + response.msg + '?ver=' + Math.random() + '" type="video/mp4">' + '<object data="movie.mp4" width="100%" height="100%">' + '<embed src="movie.swf" width="100%" height="100%">' + '</object>' + '</video>' + '</div>' + '</div>' + '</div>' + '<div class="graybg block" id="graybg"></div>';
        $('body').append(html);
    }, 'json')
}

function preVideoByURL(v_url, screen_type) {
    if ($('#layer-box').length > 0) {
        closePreLayer()
    }
    var pre_width, pre_height, pre_margin_left, pre_margin_top;
    switch (screen_type) {
        case 1:
            pre_width = 270;
            pre_height = 480;
            pre_margin_left = 135;
            pre_margin_top = 240;
            break;
        case 2:
            pre_width = 728;
            pre_height = 413;
            pre_margin_left = 364;
            pre_margin_top = 206;
            break;
        case 3:
            pre_width = 413;
            pre_height = 413;
            pre_margin_left = 206;
            pre_margin_top = 364;
            break;
        default:
            pre_width = 728;
            pre_height = 413;
            pre_margin_left = 364;
            pre_margin_top = 206
    }
    var html = '<div class="previewlayer" id="layer-box" style="width: ' + pre_width + 'px; height: ' + pre_height + 'px; padding: 5px; margin-left: -' + pre_margin_left + 'px;margin-top: -' + pre_margin_top + 'px;">' + '<div class="closed" onclick="closePreLayer()">×</div>' + '<div class="contm clearfix">' + '<div class="video fl" style="width: 100%; height: 100%;">' + '<video width="100%" height="100%" controls="controls" style="background:#5C595A;" id="video" autoplay="autoplay" loop="loop">' + '<source src="' + v_url + '?ver=' + Math.random() + '" type="video/mp4">' + '<object data="movie.mp4" width="100%" height="100%">' + '<embed src="movie.swf" width="100%" height="100%">' + '</object>' + '</video>' + '</div>' + '</div>' + '</div>' + '<div class="graybg block" id="graybg"></div>';
    $('body').append(html)
}

function imgEdit(_obj) {
    $('.sprt').removeClass('on');
    $(_obj).removeClass('hover');
    $(_obj).addClass('on');
    var material = $(_obj).attr('data-new_source');
    var source = $(_obj).attr('data-source');
    var img_id = $(_obj).attr('data-img_id');
    var fileExt = getExt(source).ext;
    var require_w = $(_obj).attr('data-width');
    var require_h = $(_obj).attr('data-height');
    cur_material_id = parseInt($(_obj).attr('data-material-id'));
    var cur_sce_id = parseInt($(_obj).attr('data-scene-id'));
    var cur_sce_mat_id = parseInt($(_obj).attr('data-sce-mat-id'));
    var material_count = $('#material-count').val();
    var aspectRatio = require_w / require_h;
    var style = '<style>' + '*{margin: 0;padding: 0;}' + '.filter_1{position: relative;-webkit-filter: contrast(110%) brightness(110%) saturate(130%);filter: contrast(110%) brightness(110%) saturate(130%);}' + '.filter_1:before{content:"";display: block;height: 100%;width: 100%;top: 0;left: 0;position: absolute;pointer-events: none;mix-blend-mode: screen;background: rgba(243, 106, 188, 0.3);}' + '.filter_3{-webkit-filter: contrast(110%) brightness(110%) sepia(30%) grayscale(100%);filter: contrast(110%) brightness(110%) sepia(30%) grayscale(100%);}' + '.filter_3:before{content:"";display: block;height: 100%;width: 100%;top: 0;left: 0;position: absolute;pointer-events: none;background: rgba(0, 0, 0, 0);}' + '.filter_2{position: relative;-webkit-filter: contrast(90%) brightness(120%) saturate(85%) hue-rotate(20deg);filter: contrast(90%) brightness(120%) saturate(85%) hue-rotate(200deg)}' + '.filter_2:before{content:"";display: block;height: 100%;width: 100%;top: 0;left: 0;position: absolute;pointer-events: none;mix-blend-mode: darken;background: -webkit-linear-gradient(to right, rgba(66, 10, 14, 0.2) 1, rgba(66, 10, 14, 0));background: linear-gradient(to right, rgba(66, 10, 14, 0.2) 1, rgba(66, 10, 14, 0));}' + '.filter_4{position: relative;-webkit-filter: contrast(85%) brightness(110%) saturate(75%) sepia(22%);filter: contrast(85%) brightness(110%) saturate(75%) sepia(22%);}' + '.filter_4:before{content:"";display: block;height: 100%;width: 100%;top: 0;left: 0;position: absolute;pointer-events: none;mix-blend-mode: soft-light;opacity: 0.5;background: rgba(173, 205, 239, 1);}' + '.filter_5{position:relative;-webkit-filter:brightness(110%) contrast(110%) saturate(130%) ;filter:brightness(110%) contrast(110%) saturate(130%) ;}' + '.filter_5:before{content:"";display:block;height:100%;width:100%;top:0px;left:0px;pointer-events:none;position:absolute;mix-blend-mode:screen;opacity:1;background:rgba(243, 106, 188, 0.3);}' + '.filter_6{position:relative;-webkit-filter:contrast(150%) saturate(110%) ;filter:contrast(150%) saturate(110%) ;}' + '.filter_6:before{content:"";display:block;height:100%;width:100%;top:0px;left:0px;pointer-events:none;position:absolute;mix-blend-mode:multiply;opacity:1;background:-webkit-radial-gradient(undefined, circle undefined, rgba(0, 0, 0, 0) 70%, rgba(34, 34, 34, 1) 100% );}' + '.filter_7{position:relative;-webkit-filter:sepia(22%) brightness(110%) contrast(85%) saturate(75%) ;filter:sepia(22%) brightness(110%) contrast(85%) saturate(75%) ;}' + '.filter_7:before{content:"";display:block;height:100%;width:100%;top:0px;left:0px;pointer-events:none;position:absolute;mix-blend-mode:soft-light;opacity:0.5;background:rgba(173, 205, 239, 1);}' + '.filter_8{position:relative;-webkit-filter:brightness(90%) contrast(150%) ;filter:brightness(90%) contrast(150%) ;}' + '.filter_8:before{content:"";display:block;height:100%;width:100%;top:0px;left:0px;pointer-events:none;position:absolute;mix-blend-mode:screen;opacity:0.5;background:-webkit-radial-gradient(undefined, circle undefined, rgba(15, 78, 128, 1) 1%, rgba(59, 0, 59, 1) 100% );}' + '.filter_9{position:relative;-webkit-filter:sepia(30%) brightness(110%) saturate(160%) hue-rotate(350deg) ;filter:sepia(30%) brightness(110%) saturate(160%) hue-rotate(350deg) ;}' + '.filter_9:before{content:"";display:block;height:100%;width:100%;top:0px;left:0px;pointer-events:none;position:absolute;mix-blend-mode:screen;opacity:0.3;background:rgba(204, 68, 0, 1);}' + '.filter_10{position:relative;-webkit-filter:sepia(30%) ;filter:sepia(30%) ;}' + '.filter_10:before{content:"";display:block;height:100%;width:100%;top:0px;left:0px;pointer-events:none;position:absolute;mix-blend-mode:color-burn;opacity:1;background:-webkit-radial-gradient(undefined, circle undefined, rgba(224, 231, 230, 1) 40%, rgba(43, 42, 161, 0.6) 100% );}' + '.filter_11{position:relative;-webkit-filter:sepia(30%) brightness(110%) contrast(110%) grayscale(100%) ;filter:sepia(30%) brightness(110%) contrast(110%) grayscale(100%) ;}' + '.filter_11:before{content:"";display:block;height:100%;width:100%;top:0px;left:0px;pointer-events:none;position:absolute;opacity:1;background:rgba(0, 0, 0, 0);}' + '.filter_12{position:relative;-webkit-filter:brightness(120%) contrast(90%) saturate(110%) ;filter:brightness(120%) contrast(90%) saturate(110%) ;}' + '.filter_12:before{content:"";display:block;height:100%;width:100%;top:0px;left:0px;pointer-events:none;position:absolute;mix-blend-mode:multiply;opacity:0.5;background:-webkit-radial-gradient(undefined, circle undefined, rgba(255, 177, 166, 1) 50%, rgba(52, 33, 52, 1) 100% );}' + '.filter_13{position:relative;-webkit-filter:sepia(20%) contrast(90%) ;filter:sepia(20%) contrast(90%) ;}' + '.filter_13:before{content:"";display:block;height:100%;width:100%;top:0px;left:0px;pointer-events:none;position:absolute;mix-blend-mode:overlay;opacity:1;background:-webkit-radial-gradient(undefined, circle undefined, rgba(208, 186, 142, 1) 20%, rgba(29, 2, 16, 0.2) 100% );}' + '.filter_14{position:relative;-webkit-filter:brightness(110%) contrast(90%) ;filter:brightness(110%) contrast(90%) ;}' + '.filter_14:before{content:"";display:block;height:100%;width:100%;top:0px;left:0px;pointer-events:none;position:absolute;mix-blend-mode:overlay;opacity:1;background:-webkit-radial-gradient(center center, circle closest-corner, rgba(168, 223, 193, 0.4) 1%, rgba(183, 196, 200, 0.2) 100% );}' + '.filter_15{position:relative;-webkit-filter:brightness(120%) contrast(90%) saturate(85%) hue-rotate(20deg) ;filter:brightness(120%) contrast(90%) saturate(85%) hue-rotate(20deg) ;}' + '.filter_15:before{content:"";display:block;height:100%;width:100%;top:0px;left:0px;pointer-events:none;position:absolute;mix-blend-mode:darken;opacity:1;background:linear-gradient( to right, rgba(66, 10, 14, 0.2) 1%, rgba(66, 10, 14, 0) 100% );}' + '.filter_16{position:relative;-webkit-filter:brightness(110%) contrast(110%) saturate(130%) ;filter:brightness(110%) contrast(110%) saturate(130%) ;}' + '.filter_16:before{content:"";display:block;height:100%;width:100%;top:0px;left:0px;pointer-events:none;position:absolute;mix-blend-mode:screen;opacity:1;background:rgba(243, 106, 188, 0.3);}' + '.origin{margin:0;padding: 0;position: relative;}' + '.origin img{margin: 0 auto;padding: 0;position: absolute;top:0;left:0;}' + '</style>';
    // var imgSrc = $('#alioss-domain').val() + material + '?x-oss-process=image/resize,m_pad,h_100,w_100';
    var imgSrc = material;
    var loading_img = '/static/index/images/loading.gif';
    var html = '<div class="graybg" id="graybg"></div>' + '<div class="origin" id="origin" style="display: none">' + style + '<figure class="filter_0">' + '<img id="origin-img">' + '</figure>' + '</div>' + '<div class="vdtkmain modal-edit-img" id="layer-box">' + '<div class="closed" onclick="closeLayer()">×</div>' + '<div class="clearfix conts">';
    var browser_type = BrowserType();
    if (browser_type !== "IE" && browser_type !== "Edge" && browser_type !== "FF") {
        html += '<div class="leftfilter fl">' + '<h2>滤镜</h2>' + '<ul>' + '<li class="on" id="filter_0" data-id="0"><div class="thumb"><figure class="filter_0"><img src="' + imgSrc + '"/></figure></div><span>原图</span></li>' + '<li id="filter_1" data-id="1"><div class="thumb"><figure class="filter_1"><img src="' + imgSrc + '"/></figure></div><span>滤镜1</span></li>' + '<li id="filter_2" data-id="2"><div class="thumb"><figure class="filter_2"><img src="' + imgSrc + '"/></figure></div><span>滤镜2</span></li>' + '<li id="filter_3" data-id="3"><div class="thumb"><figure class="filter_3"><img src="' + imgSrc + '"/></figure></div><span>滤镜3</span></li>' + '<li id="filter_4" data-id="4"><div class="thumb"><figure class="filter_4"><img src="' + imgSrc + '"/></figure></div><span>滤镜4</span></li>' + '<li id="filter_5" data-id="5"><div class="thumb"><figure class="filter_5"><img src="' + imgSrc + '"/></figure></div><span>滤镜5</span></li>' + '<li id="filter_6" data-id="6"><div class="thumb"><figure class="filter_6"><img src="' + imgSrc + '"/></figure></div><span>滤镜6</span></li>' + '<li id="filter_7" data-id="7"><div class="thumb"><figure class="filter_7"><img src="' + imgSrc + '"/></figure></div><span>滤镜7</span></li>' + '<li id="filter_8" data-id="8"><div class="thumb"><figure class="filter_8"><img src="' + imgSrc + '"/></figure></div><span>滤镜8</span></li>' + '<li id="filter_9" data-id="9"><div class="thumb"><figure class="filter_9"><img src="' + imgSrc + '"/></figure></div><span>滤镜9</span></li>' + '<li id="filter_10" data-id="10"><div class="thumb"><figure class="filter_10"><img src="' + imgSrc + '"/></figure></div><span>滤镜10</span></li>' + '<li id="filter_11" data-id="11"><div class="thumb"><figure class="filter_11"><img src="' + imgSrc + '"/></figure></div><span>滤镜11</span></li>' + '<li id="filter_12" data-id="12"><div class="thumb"><figure class="filter_12"><img src="' + imgSrc + '"/></figure></div><span>滤镜12</span></li>' + '<li id="filter_13" data-id="13"><div class="thumb"><figure class="filter_13"><img src="' + imgSrc + '"/></figure></div><span>滤镜13</span></li>' + '<li id="filter_14" data-id="14"><div class="thumb"><figure class="filter_14"><img src="' + imgSrc + '"/></figure></div><span>滤镜14</span></li>' + '<li id="filter_15" data-id="15"><div class="thumb"><figure class="filter_15"><img src="' + imgSrc + '"/></figure></div><span>滤镜15</span></li>' + '<li id="filter_16" data-id="16"><div class="thumb"><figure class="filter_16"><img src="' + imgSrc + '"/></figure></div><span>滤镜16</span></li>' + '</ul>' + '</div>'
    } else {
        html += '<div class="leftfilter fl">' + '<h2>滤镜</h2>' + '<h1 style="margin-top: 20px">您的浏览器不兼容css3滤镜，要使用滤镜功能请使用chrome内核，如不需要请继续剪裁图片</h1>' + '</div>'
    }
    html += '<div class="czmain fr">' + '<div class="content">' + '<div class="show" id="show" style="position: relative">' + '<img id="loadingImg" src="' + loading_img + '" style="position: absolute; left: 50%; top: 50%; height: 60px; margin-top: -30px; margin-left: -30px; z-index: 999;"/>' + '<img id="myImg"/>' + '</div>' + '</div>' + '<div class="btns">' + '<a href="javascript:void(0);" id="crop-rotate">旋转</a><a href="javascript:void(0);" id="changeMaterial">替换</a><a href="javascript:void(0);" id="crop-reset" style="display: none">重置</a>' + '</div>' + '<a class="btn-commit" href="javascript:void(0);" id="btn-img-commit">加载中...</a>' + '</div>' + '</div>' + '</div>';
    $("body").append(html);
    var layer_box = $('#layer-box');
    layer_box.css("opacity", "0");
    layer_box.animate({opacity: 1}, 500);
    var loadingImg = $('#loadingImg');
    commitable = !1;
    var origin_img = document.getElementById('origin-img');
    $('#changeMaterial').click(function () {
        closeLayer();
        imgAdd(_obj, 1)
    });
    $.post('/index/member/getMaterial', {'material': material}, function (response) {
        imgSrc = material;
        origin_img.src = imgSrc;
        var myImg = $('#myImg');
        setMyImgSize(response.width, response.height, 550, 350, myImg);
        myImg.attr('src', imgSrc);
        var filter_o = 0;
        var cur_filter = 0;
        var first_load = !0;
        var crop_data_o, crop_data;
        var btn_img_commit = $('#btn-img-commit');
        $('#crop-rotate').click(function () {
            myImg.cropper('rotate', -45)
        });
        $('#crop-reset').click(function () {
            var filter_0 = $('#filter_0');
            filter_0.addClass('on').siblings().removeClass('on');
            crop_data = null;
            $('.origin figure').removeClass().addClass('filter_0');
            changeFilter(response.width, response.height)
        });
        $('.leftfilter ul li').click(function () {
            $(this).addClass('on').siblings().removeClass('on');
            cur_filter = $(this).data('id');
            crop_data = myImg.cropper("getData");
            $('.origin figure').removeClass().addClass($(this).find('figure').attr('class'));
            changeFilter(response.width, response.height)
        });
        myImg.cropper({
            aspectRatio: aspectRatio,
            viewMode: 0,
            autoCropArea: 1,
            scalable: !1,
            restore: !1,
            guides: !1,
            center: !1,
            highlight: !1,
            cropBoxMovable: !1,
            cropBoxResizable: !1,
            checkCrossOrigin: !1,
            toggleDragModeOnDblclick: !1,
            dragMode: 'move',
            ready: function () {
                btn_img_commit.text('确定');
                loadingImg.hide();
                commitable = !0;
                if (first_load) {
                    crop_data_o = myImg.cropper("getData");
                    // if (G_scenes.scenes[cur_sce_id].materials[cur_sce_mat_id].cd !== undefined) {
                    //     crop_data_o = G_scenes.scenes[cur_sce_id].materials[cur_sce_mat_id].cd;
                    //     floatObj(crop_data_o);
                    //     myImg.cropper('setData', crop_data_o)
                    // }
                    // if (G_scenes.scenes[cur_sce_id].materials[cur_sce_mat_id].f !== undefined && browser_type !== "IE" && browser_type !== "Edge" && browser_type !== "FF") {
                    //     cur_filter = parseInt(G_scenes.scenes[cur_sce_id].materials[cur_sce_mat_id].f);
                    //     if (cur_filter > 0) {
                    //         filter_o = cur_filter;
                    //         var filter_cur = $('#filter_' + cur_filter);
                    //         filter_cur.addClass('on').siblings().removeClass('on');
                    //         $('.origin figure').removeClass().addClass(filter_cur.find('figure').attr('class'));
                    //         changeFilter(response.width, response.height)
                    //     }
                    // }
                    crop_data = crop_data_o;
                    first_load = !1
                } else {
                    if (crop_data !== null) {
                        myImg.cropper('setData', crop_data)
                    }
                }
            },
            crop: function (e) {
            }
        });
        btn_img_commit.click(function () {
            if (commitable) {
                $(this).text('提交中...');
                loadingImg.show();
                commitable = !1;
                crop_data = myImg.cropper("getData");
                if (cmpObj(crop_data, crop_data_o) && filter_o === cur_filter) {
                    if (autoTab === !0 && cur_material_id < material_count) {
                        editNextMaterial(cur_material_id, material_count)
                    } else {
                        closeLayer()
                    }
                    loadingImg.hide();
                    commitable = !0
                } else {
                    var canvasType = fileExt === 'jpg' ? 'image/jpeg' : 'image/png';
                    var fillColor = fileExt === 'jpg' ? '#FFF' : '';
                    var tmp_canvas = myImg.cropper('getCroppedCanvas', {
                        'width': require_w,
                        'height': require_h,
                        'fillColor': fillColor
                    });
                    var cropDataURL = tmp_canvas.toDataURL(canvasType);
                    var params = {};
                    params.image = cropDataURL;
                    params.name = source;
                    params.img_id = img_id;
                    // params.mem_temp_id = temp_id;
                    upToAlioss(params, function (response) {
                        if (!response.status) {
                            diybox.alert(response.message);
                            $(this).text('确定');
                            loadingImg.hide();
                            commitable = !0
                        } else {
                            var cropped = source;
                            // $(_obj).attr('data-cropped', cropped);
                            $(_obj).attr('data-new_source', response.data);
                            $(_obj).find('img').eq(0).attr('src', response.thum_img);
                            // $(_obj).find('img').eq(0).one('load',function () {
                            diybox.msg(response.message);
                            // });
                            closeLayer();
                            loadingImg.hide();
                            commitable = !0
                            // G_scenes.scenes[cur_sce_id].materials[cur_sce_mat_id].cropped = cropped;
                            // G_scenes.scenes[cur_sce_id].materials[cur_sce_mat_id].cd = crop_data;
                            // G_scenes.scenes[cur_sce_id].materials[cur_sce_mat_id].f = cur_filter;
                            // saveScenes(G_status_complete, G_scenes, temp_id, function (res) {
                            //     if (res.error) {
                            //         diybox.alert(res.msg);
                            //         loadingImg.hide();
                            //         $(this).text('确定');
                            //         commitable = !0
                            //     } else {
                            //         var timestamp = new Date().getTime();
                            //         G_last_save = Math.round(timestamp / 1000);
                            //         diybox.msg(res.msg);
                            //         if (autoTab === !0 && cur_material_id < material_count) {
                            //             editNextMaterial(cur_material_id, material_count)
                            //         } else {
                            //             closeLayer()
                            //         }
                            //         loadingImg.hide();
                            //         commitable = !0
                            //     }
                            // })
                        }
                    })
                }
            }
        })
    }, 'json');
    cancelBubble();
    return !1
}

function imgAdd(_obj, type) {
    if (clickable) {
        $('.sprt').removeClass('on');
        $(_obj).removeClass('hover');
        $(_obj).addClass('on');
        var data = $(_obj).data();
        var imgid = data.img_id;
        cur_material_id = data.materialId;
        var cur_sce_id = parseInt(data.sceneId);
        var cur_sce_mat_id = parseInt(data.sceMatId);
        var domain = $('#alioss-domain').val();
        var path = $('#template-path').val();
        var require_w = parseInt(data.width);
        var require_h = parseInt(data.height);
        var require_s = require_w > require_h ? '横幅' : '竖幅';
        var src = $(_obj).find('img').eq(0).attr('src');
        var material_count = $('#material-count').val();
        var html = '<div class="graybg" id="graybg"></div>' + '<div class="vdtkmain modal-add-img" id="layer-box" style="width: 850px">' + '<div class="progress-bar" style="height: 5px;width: 0;position: absolute;left:0;top: 0;"></div>' + '<div class="picbg"><img id="default-img" src="' + src + '"/></div>' + '<div class="closed" onclick="closeLayer()">×</div>' + '<div class="cont">' + '<div class="uploadbtn">' + '<div class="arc animation1"></div>' + '<div class="arc animation2"></div>' + '<div class="arc animation3"></div>' + '<div class="btns" id="single-upload-btns">' + '<a id="single-upload">' + '<img src="/static/index/images/uploadbtn.png">' + '</a>' + '</div>' + '</div>' + '<ul class="clearfix cmt">' + '<li>图片</li>' + '<li>' + require_s + '</li>' + '</ul>' + '</div>' + '</div>';
        $("body").append(html);
        var layer_box = $('#layer-box');
        layer_box.css("opacity", "0");
        layer_box.animate({opacity: 1}, 500);
        var uploader_single = new plupload.Uploader({
            runtimes: 'html5,flash,silverlight,html4',
            browse_button: 'single-upload',
            multi_selection: !1,
            container: document.getElementById('single-upload-btns'),
            flash_swf_url: '/static/index/other/Moxie.swf',
            silverlight_xap_url: '/static/index/other/Moxie.xap',
            url: 'http://oss.aliyuncs.com',
            filters: {mime_types: [{title: "Image files", extensions: "jpg,jpeg,png"}], max_file_size: '20mb'},
            resize: {height: 2048, quality: 100, crop: !1, preserve_headers: !1},
            init: {
                PostInit: function () {
                }, FilesAdded: function (up, files) {
                    var files_count = files.length;
                    plupload.each(files, function (file, i) {
                        if (!file || !/image\//.test(file.type)) return;
                        var preloader = new mOxie.Image();
                        preloader.onload = function () {
                            if (preloader.height <= 10000 && preloader.width <= 10000) {
                                preloader.downsize(922, 530);
                                var imgSrc = preloader.type === 'image/jpeg' ? preloader.getAsDataURL('image/jpeg', 80) : preloader.getAsDataURL();
                                document.getElementById('default-img').src = imgSrc;
                                preloader.destroy();
                                preloader = null;
                                if (i === files_count - 1) {
                                    set_upload_param(uploader_single, '', !1,imgid)
                                }
                            } else {
                                preloader.destroy();
                                preloader = null;
                                diybox.alert('文件“' + file.name + '”宽或高超过10000，请处理后再上传', function () {
                                    loadMaterials()
                                })
                            }
                        };
                        preloader.load(file.getSource())
                    })
                }, BeforeUpload: function (up, file) {
                    set_upload_param(up, file.name, !0,imgid);
                    $('.closed').hide();
                    $('.prematerial').hide();
                    $('.nextmaterial').hide();
                    $('.uploadbtn').hide();
                }, UploadProgress: function (up, file) {
                    var d = document.getElementsByClassName('progress-bar')[0];
                    d.style.width = file.percent + '%'
                }, FileUploaded: function (up, file, info) {
                    if (info.status === 200) {
                        var respons = JSON.parse(info.response);
                        loadMaterials();
                        $(_obj).find('img').eq(0).attr('src',respons.thum_img);
                        diybox.msg("上传成功");
                        // var up_file_name = get_uploaded_object_name(file.name);
                        // console.log(up_file_name);
                        var cur_material_dom = $('#material_img_' + imgid);
                        cur_material_dom.attr("ondblclick", 'imgEdit(this)').removeAttr('onclick');
                        $(_obj).attr('data-new_source', respons.data);
                        cur_material_dom.find('img').eq(0).attr('data-has-image', '1');
                        drag_type = 0;
                        closeLayer();
                        cur_material_dom.trigger('dblclick').find('img').eq(0).css('opacity', 1);
                    }
                    else {/*document.getElementById(file.id).getElementsByTagName('b')[0].innerHTML = info.response;*/
                        diybox.msg("上传出错");
                        $('.closed').show();
                        $('.prematerial').show();
                        $('.nextmaterial').show();
                        $('.uploadbtn').show();
                    }
                }, UploadComplete: function () {
                    loadMaterials();
                }, Error: function (up, err) {
                    if (err.code === -600) {/*document.getElementById('console').appendChild(document.createTextNode("\n选择的文件太大了,可以根据应用情况，在upload.js 设置一下上传的最大大小"));*/
                    }
                    else if (err.code === -601) {/*document.getElementById('console').appendChild(document.createTextNode("\n选择的文件后缀不对,可以根据应用情况，在upload.js进行设置可允许的上传文件类型"));*/
                    }
                    else if (err.code === -602) {/*document.getElementById('console').appendChild(document.createTextNode("\n这个文件已经上传过一遍了"));*/
                    }
                    else {/*document.getElementById('console').appendChild(document.createTextNode("\nError xml:" + err.response));*/
                    }
                    $('.closed').show();
                    $('.prematerial').show();
                    $('.nextmaterial').show();
                    $('.uploadbtn').show()
                }
            }
        });
        uploader_single.init();
        cancelBubble();
        return !1
    }
}

function textEdit(_obj, e) {
    $('.sprt').removeClass('on');
    $(_obj).removeClass('hover');
    $(_obj).addClass('on');
    var words = $(_obj).children().text();
    var data = $(_obj).data();
    cur_material_id = parseInt(data.materialId);
    var cur_sce_id = parseInt(data.sceneId);
    var cur_sce_mat_id = parseInt(data.sceMatId);
    var scene_id = data.sceneId;
    var domain = $('#alioss-domain').val();
    var path = $('#template-path').val();
    var src = $('#testPic').attr('src');
    var textid = data.text_id;
    var material_count = $('#material-count').val();
    var words_len = 0;
    // if (G_scenes.isNew === undefined) {
    //     words_len = words.length
    // } else {
    //     words_len = getByteLen(words)
    // }
    var html = '<div class="graybg" id="graybg"></div>' + '<div class="vdtkmain modal-edit-text" id="layer-box">' + '<div class="picbg"><img src="' + src + '" /></div>' + '<div class="closed" onclick="closeLayer()">×</div>' + '<div class="cont"><div class="textcont fl">' + '<input type="text" id="edit-text" class="webtxt" maxlength="' + data.size_content + '" placeholder="为空则使用默认文字，想要不显示文字请输入至少一个空格">' + '<span>' + '最大字数:' + data.size_content + '</span>' + '</div>' + '<div class="btns fr"><a href="javascript:void(0);" id="btn-text-commit">确认</a><a href="javascript:closeLayer();">取消</a></div></div>' + '</div>';
    $("body").append(html);
    $('.webtxt').focus().val(words);
    var layer_box = $('#layer-box');
    layer_box.css("opacity", "0");
    layer_box.animate({opacity: 1}, 500);
    var edit_text = $('#edit-text');
    if (words_len === parseInt(edit_text.attr('maxlength'))) {
        edit_text.css('color', '#4dd3c5')
    }
    $('#btn-text-commit').click(function () {
        // if (commitable) {
            var new_content = $('#edit-text').val();
            var old_content = data.content;
            if (new_content !== old_content) {
                $(this).text('提交中...');
                var postData = {'text':new_content,'id':textid};
                commitable = !1;
                $.post('/index/member/saveText', postData, function (response) {
                    if (response.error) {
                        diybox.alert(response.message, function () {
                            $('#btn-text-commit').text('确认');
                            commitable = !0
                        })
                    } else {
                        $('#btn-text-commit').text('确认');
                        $(_obj).attr('data-new_content', new_content);
                        if (new_content) {
                            $(_obj).children().text(new_content)
                        }
                        diybox.msg(response.message);
                        closeLayer();
                        commitable = !0;
                    }
                }, 'json')

            } else {
                closeLayer();
            }
        // }
    });
    // edit_text.on('input', function (e) {
    //     var txt_length = 0;
    //     var val = $(this).val();
    //     var max_length = parseInt($(this).attr('maxlength'));
    //     if (G_scenes.isNew === undefined) {
    //         txt_length = val.length;
    //         if (txt_length === max_length) {
    //             $(this).css('color', '#4dd3c5')
    //         } else {
    //             $(this).css('color', '#FFFFFF')
    //         }
    //     } else {
    //         if (compositionstatus === 0) {
    //             txt_length = getByteLen(val);
    //             if (txt_length < max_length) {
    //                 $(this).css('color', '#FFFFFF')
    //             } else {
    //                 $(this).css('color', '#4dd3c5');
    //                 var val_cut = byteCut(val, max_length);
    //                 $(this).val(val_cut);
    //                 txt_length = getByteLen(val_cut)
    //             }
    //         }
    //     }
    //     $(this).next().children('i').text(txt_length)
    // }).on('compositionstart', function () {
    //     compositionstatus = 1
    // }).on('compositionend', function () {
    //     compositionstatus = 0;
    //     if (G_scenes.isNew !== undefined) {
    //         var val = $(this).val();
    //         var max_length = parseInt($(this).attr('maxlength'));
    //         var txt_length = getByteLen(val);
    //         if (txt_length < max_length) {
    //             $(this).css('color', '#FFFFFF')
    //         } else {
    //             var val_cut = byteCut(val, max_length);
    //             $(this).val(val_cut);
    //             txt_length = getByteLen(val_cut);
    //             if (txt_length < max_length)
    //                 $(this).css('color', '#FFFFFF'); else $(this).css('color', '#4dd3c5')
    //         }
    //         $(this).next().children('i').text(txt_length)
    //     }
    // });
    cancelBubble();
    return !1
}

function closeLayer() {
    $("#layer-box").remove();
    $('#graybg').remove();
    $('#origin').remove();
    if (thumb_timer) clearInterval(thumb_timer);
    thumb_index = 2
}

function closePreLayer() {
    $("#layer-box").remove();
    $('#graybg').remove();
    $('#render-progress').hide();
    if (typeof _title !== "undefined") {
        document.title = _title
    }
}

function closeAudioLayer() {
    $("#layer-box").remove();
    $('#graybg').remove();
    var player = document.getElementById('player');
    player.removeEventListener("timeupdate", acp_timeupdate);
    player.src = '';
    if (old_music_start !== music_start) {
        $.post('/member/video/saveBgmStart', {'id': temp_id, 'bgm_start': music_start}, function (response) {
            if (response.error) {
                diybox.alert(response.msg);
                return !1
            }
            var timestamp = new Date().getTime();
            G_last_save = Math.round(timestamp / 1000);
            diybox.msg(response.msg, 1500);
            old_music_start = music_start
        }, 'json')
    }
}

function editPreMaterial(mid) {
    if (mid === 1) {
        diybox.msg('已经是第一个素材了');
        return !1
    }
    closeLayer();
    var pre_mid = mid - 1;
    var cur_material = $('#material_' + pre_mid);
    cur_material.triggerHandler('click');
    cur_material.triggerHandler('dblclick');
    var scene_key = cur_material.attr('data-scene-id');
    var scene_obj = $('#scene_' + scene_key);
    var scenes_detail = $('#scenes-detail');
    scene_obj.addClass('on').siblings().removeClass('on');
    var scroll_distance = scenes_detail.scrollTop() + scene_obj.offset().top - 265;
    scenes_detail.animate({scrollTop: scroll_distance}, 500);
    scroll_thumb(scene_key)
}

function editNextMaterial(mid, mcount) {
    if (mid === mcount) {
        diybox.msg('已经是最后一个素材了');
        return !1
    }
    closeLayer();
    var next_mid = mid + 1;
    var cur_material = $('#material_' + next_mid);
    cur_material.triggerHandler('click');
    cur_material.triggerHandler('dblclick');
    var scene_key = cur_material.attr('data-scene-id');
    var scene_obj = $('#scene_' + scene_key);
    var scenes_detail = $('#scenes-detail');
    scene_obj.addClass('on').siblings().removeClass('on');
    var scroll_distance = scenes_detail.scrollTop() + scene_obj.offset().top - 265;
    scenes_detail.animate({scrollTop: scroll_distance}, 500);
    scroll_thumb(scene_key)
}

function setMyImgSize(w, h, pw, ph, _o) {
    var ration_parent = pw / ph, origin_ration = w / h;
    if (origin_ration > ration_parent) {
        _o.css('width', '100%')
    } else {
        _o.css('height', '100%')
    }
}

function changeFilter(w, h) {
    var myImg = $('#myImg');
    var loadingImg = $('#loadingImg');
    loadingImg.show();
    $("#btn-img-commit").text('加载中...');
    commitable = !1;
    var origin_img = document.getElementById("origin");
    var html = origin_img.innerHTML;
    rasterizeHTML.drawHTML(html).then(function (renderResult) {
        var canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        var context = canvas.getContext('2d');
        context.drawImage(renderResult.image, 0, 0);
        var dataUrl = canvas.toDataURL();
        var blobUrl = dataURLtoBlobUrl(dataUrl);
        myImg.cropper('replace', blobUrl)
    })
}

function dataURLtoBlobUrl(dataurl) {
    var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]), n = bstr.length,
        u8arr = new Uint8Array(n);
    while (n--) {
        u8arr[n] = bstr.charCodeAt(n)
    }
    var blob = new Blob([u8arr], {type: mime});
    return URL.createObjectURL(blob)
}

function upToAlioss(params, callback) {
    $.post('/index/member/saveImage', params, function (response) {
        (callback)(response)
    }, 'json')
}

function getExt(filename) {
    var fileArr = filename.split('.');
    return {'name': fileArr[0], 'ext': fileArr[1].toLowerCase()}
}

function acp_timeupdate() {
    var music_end = music_start + temp_len;
    var player = document.getElementById('player');
    if (player.currentTime >= music_end) {
        player.currentTime = music_start
    }
    document.getElementById('acp-progress').style.width = Math.round((player.currentTime - music_start) / temp_len * 100) + '%'
}

function set_pre_thumb_index(index, video) {
    var thumb_ul = $(".thumb-list ul");
    var thumb_li = $(".thumb-list ul li");
    var thumb_li_len = thumb_li.length;
    if (thumb_li_len > 5) {
        var marginLeft;
        if (index > 2 && index < thumb_li_len - 3) {
            marginLeft = -(index - 2) * 186;
            thumb_ul.css('margin-left', marginLeft + 'px')
        } else if (index <= 2) {
            thumb_ul.css('margin-left', 0)
        } else if (index >= thumb_li_len - 3) {
            marginLeft = -(thumb_li_len - 5) * 186;
            thumb_ul.css('margin-left', marginLeft + 'px')
        }
    }
    if (video !== undefined) {
        video.currentTime = get_pre_thumb_time(index)
    }
}