var query_pay_interval;
var pay_commitable;

function autotab(title, cont) {
    var num = $(title).length, index = 0;
    $(cont).hide().eq(0).fadeToggle(500);
    $(title).click(function () {
        var s = $(title).index(this);
        $(this).addClass("on").siblings().removeClass("on");
        $(cont).hide().eq(s).fadeToggle(500);
        index = $(this).index()
    })
}

function show_pay_modal(mtid, tid, size) {
    var title = size === 1 ? '即将生成成片，生成后不可改，请通过预览确认无误后生成。' : '即将生成预览，预览不限次数，生成需等待，请先确认无误。';
    pay_commitable = !0;
    var html = '<div class="graybg" id="graybg"></div>' + '<div class="zhifutkmain unselectable" id="pay-layer">' + '<div class="closed" onclick="close_pay_modal()">×</div>' + '<ul class="mtitle clearfix"><li class="on">模板购买</li><li>个人充值</li><li>企业充值</li></ul><a href="/store.html" class="go-gift-shop" target="_blank">查看兑换礼品</a>' + '<div class="contmtb">' + '<div class="bzprt">' + '<div class="stips"><p>当前是高峰期，为保障速度，支付后可生成。您的支持，助我们为您提供更大价值。</p><p>此视频需支付<em id="mt_price">0.00</em>元，' + title + '</p></div><div class="zftle">请选择支付方式</div>' + '<div class="smpt clearfix"><div class="yuecont fl on" id="direct-pay"><i>余额支付</i><span><em>0.00</em>元</span></div><div class="splt fl"><span>账户余额：<em>0.00</em>元&emsp;可用现金劵：<em>0.00</em>元 <a href="javascript:goPay();">去充值</a></span><span>标价包含一次无水印超清成片生成和不限次有水印标清预览生成。</span></div></div>' + '<div class="btns"><a href="javascript:confirmPay(' + mtid + ',' + tid + ',' + size + ')">支付</a></div>' + '</div>' + '<div class="bzprt none">' + '<div class="stipsd"><b>请选择充值数额</b>赠送以现金券形式实时到账，作品付款时自动抵扣，无门槛永久有效。</div>' + '<div class="smpt clearfix"><ul class="muncont clearfix">' + '<li data-money="98"><b>98元</b><span>无赠送</span></li><li class="on" data-money="198"><b>198元</b><span>送129元</span></li>' + '<li data-money="298"><b>298元</b><span>送229元</span></li><li data-money="398"><b>398元</b><span>送329元</span></li>' + '</ul></div>' + '<div class="smpt clearfix"><div class="zftles">请选择支付方式</div><ul class="zfwxcnt fl" id="pay-type-1"><li><img src="images/zfbico.jpg"></li><li><img src="images/wxzfico.jpg"></li></ul>' + '<div class="ewmicont fl"><div class="pic"><div style="height:100%" id="qr-container-1"><img src="images/ewmicos.jpg"></div><p id="qr-mask-1">点击左侧按钮<br>获取二维码</p></div><i></i></div>' + '<div class="ztips"><i>*</i>提示：充值资金及赠送，只可消费，不退余额。如遇网站故障可退款，相应赠送全部扣除。</div>' + '</div>' + '</div>' + '<div class="bzprt none"><div class="stipsd"><b>请选择充值数额</b>赠送以现金券形式实时到账，作品付款时自动抵扣，无门槛永久有效。</div>' + '<div class="smpt clearfix">' + '<ul class="muncont clearfix">' + '<li data-money="580"><b>580元</b><span>送488元</span></li><li data-money="980"><b>980元</b><span>送888元</span></li>' + '<li data-money="1800"><b>1800元</b><span>送2188元</span></li><li data-money="2800"><b>2800元</b><span>送3888元</span></li>' + '</ul>' + '</div>' + '<div class="smpt clearfix"><div class="zftles">请选择支付方式</div><ul class="zfwxcnt fl" id="pay-type-2"><li><img src="images/zfbico.jpg"></li><li><img src="images/wxzfico.jpg"></li></ul>' + '<div class="ewmicont fl"><div class="pic"><div style="height:100%" id="qr-container-2"><img src="images/ewmicos.jpg"></div><p id="qr-mask-2">请先选择金额<br>再选择支付方式</p></div><i></i></div>' + '<div class="ztips"><i>*</i>提示：充值资金及赠送，只可消费，不退余额。如遇网站故障可退款，相应赠送全部扣除。</div>' + '</div>' + '</div>' + '</div><iframe id="pay-success" style="display: none"></iframe>' + '</div>';
    $('body').append(html);
    autotab(".zhifutkmain .mtitle li", ".zhifutkmain .bzprt");
    var money = [];
    money[1] = 198;
    var direct_pay = $('#direct-pay');
    var cur_out_no;
    var tabIndex = 0;
    var pay_type = [];
    pay_type[0] = 3;
    $(".zhifutkmain .mtitle li").click(function () {
        tabIndex_old = tabIndex;
        tabIndex = $(this).index();
        if (tabIndex === 0 && tabIndex_old !== 0) {
            direct_pay.trigger('click')
        }
    });
    $(".gift-money").tipsy({gravity: 'n'});
    get_pay_info(mtid, function (res) {
        money[0] = res.price
    });
    direct_pay.click(function () {
        $(this).addClass('on');
        $('#third-pay').children('li').removeClass('on');
        $('#qr-mask-0').show();
        pay_type[0] = 2;
        get_pay_info(mtid, function (res) {
            money[0] = res.price
        })
    });
    $('#third-pay').children('li').click(function () {
        $(this).addClass('on').siblings('li').removeClass('on');
        $('#direct-pay').removeClass('on');
        $('#qr-mask-0').hide()
    });
    $(".zhifutkmain .muncont li").click(function () {
        var _this = $(this);
        var new_money = _this.data('money');
        if (money[tabIndex] !== new_money) {
            money[tabIndex] = new_money;
            _this.addClass('on').siblings('li').removeClass('on');
            $('#qr-mask-' + tabIndex).html('点击左侧按钮<br>获取二维码').show();
            $('#pay-type-' + tabIndex).children('li').removeClass('on');
            pay_type[tabIndex] = -1
        }
    });
    var qureyOrder = function (out_no) {
        clearInterval(query_pay_interval);
        query_pay_interval = setInterval(function () {
            $.post('/member/payment/queryOrder', {'out_no': out_no}, function (res) {
                if (!res.error) {
                    $('#qr-mask-' + tabIndex).html('点击左侧按钮<br>获取二维码').show();
                    $('#pay-type-' + tabIndex).children('li').removeClass('on');
                    $('#qr-container-' + tabIndex).html('<img src="images/ewmicos.jpg">');
                    pay_type[tabIndex] = -1;
                    $(".zhifutkmain .mtitle li").eq(0).trigger('click');
                    $('#pay-success').attr('src', '/home/home/pay_success').one('load', function () {
                        setTimeout(function () {
                            $('#pay-success').attr('src', '')
                        }, 3000)
                    });
                    clearInterval(query_pay_interval)
                }
            }, 'json')
        }, 3000)
    };
    $(".zhifutkmain .zfwxcnt li").click(function () {
        if (pay_type[tabIndex] !== $(this).index() && money[tabIndex] !== undefined) {
            $(this).addClass('on').siblings('li').removeClass('on');
            pay_type[tabIndex] = $(this).index();
            pay_loading(tabIndex);
            switch (pay_type[tabIndex]) {
                case 0:
                    if (tabIndex) {
                        gen_alipay_qrcode(money[tabIndex], tabIndex, function (res) {
                            cur_out_no = res.out_no;
                            qureyOrder(cur_out_no);
                            rid = res.rid
                        })
                    } else {
                        gen_alipay_qrcode(money[tabIndex], tabIndex, function (res) {
                            cur_out_no = res.out_no;
                            qureyOrder(cur_out_no);
                            rid = res.rid
                        }, mtid)
                    }
                    break;
                case 1:
                    if (tabIndex) {
                        gen_wxpay_qrcode(money[tabIndex], tabIndex, function (res) {
                            cur_out_no = res.msg;
                            qureyOrder(cur_out_no);
                            rid = res.rid
                        })
                    } else {
                        gen_wxpay_qrcode(money[tabIndex], tabIndex, function (res) {
                            cur_out_no = res.msg;
                            qureyOrder(cur_out_no);
                            rid = res.rid
                        }, mtid)
                    }
                    break
            }
        }
    })
}

function gen_alipay_qrcode(money, index, callback, mtid) {
    var pay_mode = mtid === undefined ? 1 : 3;
    mtid = mtid === undefined ? 0 : mtid;
    $.post('/member/payment/alipay/' + pay_mode + '/1', {'money': money, 'mtid': mtid}, function (response) {
        $('#next_btn').attr('disabled', !1);
        if (response.error) {
            diybox.alert({message: response.msg, closeBtn: !1});
            return !1
        } else {
            var html = '<iframe src="' + response.url + '" width="100%" height="100%" style="display: none;"></iframe>';
            var qr_container = $('#qr-container-' + index);
            qr_container.append(html);
            qr_container.children('iframe').one('load', function () {
                qr_container.children('img').remove();
                qr_container.children('iframe').show()
            });
            qr_container.parent().next('i').text('请用支付宝扫码付款');
            if (callback !== undefined) callback(response)
        }
    }, 'json')
}

function gen_wxpay_qrcode(money, index, callback, mtid) {
    var qrtime = Math.round(new Date().getTime() / 1000);
    var oDiv = $('<div></div>');
    var img = $('<img>');
    oDiv.append(img);
    var pay_mode = mtid === undefined ? 1 : 3;
    mtid = mtid === undefined ? 0 : mtid;
    $.get('/member/payment/gen_trade_no/' + pay_mode, {'m': money, 'mtid': mtid}, function (response) {
        if (response.error) {
            diybox.alert(response.msg);
            return !1
        }
        img.attr('src', '/member/payment/qrcode_wxpay?r=' + Math.random() + '&m=' + money + '&no=' + response.msg);
        img[0].onload = function () {
            var qr_container = $('#qr-container-' + index);
            qr_container.html(oDiv.html());
            qr_container.parent().next('i').text('请用微信扫码付款');
            if (callback !== undefined) callback(response)
        }
    }, 'json')
}

function pay_loading(index) {
    var html = '<img src="images/pay-loading.gif" width="100%" height="100%"/>';
    $('#qr-mask-' + index).hide();
    $('#qr-container-' + index).html(html)
}

function close_pay_modal() {
    $('#graybg').remove();
    $('#pay-layer').remove();
    clearInterval(query_pay_interval)
}

function goPay() {
    $(".zhifutkmain .mtitle li").eq(1).trigger('click')
}

function get_pay_info(mtid, callback) {
    $.post('/member/payment/getPayInfo/' + mtid, function (res) {
        if (res.error) {
            close_pay_modal();
            diybox.alert(res.msg);
            return !1
        }
        $('#mt_price').text(parseInt(res.msg.f_price));
        var direct_pay = $('#direct-pay');
        direct_pay.find('em').text(res.msg.f_need);
        direct_pay.next().children('span').eq(0).find('em').eq(0).text(res.msg.f_account);
        direct_pay.next().children('span').eq(0).find('em').eq(1).text(res.msg.f_coupon);
        if (callback !== undefined) callback(res.msg)
    }, 'json')
}

function confirmPay(mtid, tid, size) {
    if (pay_commitable) {
        pay_commitable = !1;
        $(this).text('支付中');
        $.post('/member/payment/comfirm_pay', {'id': mtid, 'tid': tid}, function (res) {
            if (res.error) {
                $('#pay-layer').hide();
                diybox.alert(res.msg, function () {
                    $('#pay-layer').show();
                    pay_commitable = !0;
                    if (res.next !== undefined && res.next === !0) {
                        $(".zhifutkmain .mtitle li").eq(1).trigger('click')
                    }
                });
                return !1
            }
            G_status_pay = 1;
            close_pay_modal();
            $('#template-price').text('已支付');
            if (size === 1) {
                makeVideo(temp_id, 1, function (response) {
                    if (response.status === 6) {
                        diybox.alert({
                            message: '渲染成功，点击<a href="/member/video/my_work/5.html" target="_blank">我的作品</a>',
                            closeBtn: !1
                        })
                    } else {
                        diybox.alert({message: '制片失败，请重新制片', closeBtn: !1})
                    }
                })
            } else {
                makeVideo(temp_id, 2, function (response) {
                    preVideoByURL(response.video_url, screen_type)
                })
            }
        }, 'json')
    }
}